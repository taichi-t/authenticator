name: Deploy

on:
  push:
    branches: [deployment/staging]

jobs:
  runs-on: ubuntu-latest
    build: 
        steps:

          - name: Checkout
            uses: actions/checkout@v2
            with:
              fetch-depth: 0

          - name: Use Node.js 14.x
            uses: actions/setup-node@v1
            with:
              node-version: 14.x

          - name: Build
            run: npm ci 
            run: npm run type
            run: npm run build --if-present

          - name: Deploy Server
            uses: AkhileshNS/heroku-deploy@v3.12.12
            with:
              heroku_api_key: ${{secrets.HEROKU_API_KEY}}
              heroku_email: ${{secrets.EMAIL}}
              justlogin: true
            run: |
              heroku config:add \
              MONGODB_URL=${{secrets.MONGODB_URL}} \
              GOOGLE_CLIENTID=${{secrets.GOOGLE_CLIENTID}} \
              GOOGLE_SECRET=${{secrets.GOOGLE_SECRET}} \
              SESSION_SECRET=${{secrets.SESSION_SECRET}} \
              —app ${{secrets.HEROKU_APP_NAME_STAGING}} \
              git subtree push —prefix ./dist staging master

          - name: Deploy Client       
            uses: amondnet/vercel-action@v20
            with:
              vercel-token: ${{ secrets.VERCEL_TOKEN }} 
              github-token: ${{ secrets.GITHUB }} 
              vercel-org-id: ${{ secrets.ORG_ID}}  
              vercel-project-id: ${{ secrets.PROJECT_ID}} 
              working-directory: ./public

